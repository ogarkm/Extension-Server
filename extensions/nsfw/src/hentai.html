<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Reader - Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --background-primary: #121212;
        --background-secondary: #1e1e1e;
        --foreground-primary: #e6e6e6;
        --foreground-secondary: #a0a0a0;
        --accent-primary: #FF9500;
        --accent-rgb: 255, 69, 58;
        --border-color: #2c2c2c;

        /* Reader Specific Colors */
        --reader-header-bg: rgba(20, 20, 22, 0.7);
        --reader-footer-bg: rgba(20, 20, 22, 0.85);
        --reader-border-color: rgba(255, 255, 255, 0.1);

      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background-primary);
        color: var(--foreground-primary);
        margin: 0;
      }
      /* --- Main Grid View --- */
      #main-container {
        padding: 1rem 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
      }
      .page-header {
        text-align: center;
        margin-bottom: 2rem;
      }
      .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--accent-primary);
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .search-container {
        margin-bottom: 2.5rem;
        display: flex;
        justify-content: center;
      }
      .search-input {
        width: 100%;
        max-width: 500px;
        padding: 0.875rem 1.25rem;
        font-size: 1rem;
        background-color: var(--background-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--foreground-primary);
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .search-input:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.3);
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 1.25rem;
      }
      .grid-card {
        background-color: var(--background-secondary);
        border-radius: 10px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        position: relative;
      }
      .grid-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(var(--accent-rgb), 0.25);
      }
      .grid-card img {
        width: 100%;
        height: 240px;
        object-fit: cover;
        display: block;
      }
      .grid-card .title-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 1.5rem 0.75rem 0.75rem;
        background: linear-gradient(to top, rgba(0,0,0,0.95), transparent);
      }
      .grid-card .card-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #fff;
        line-height: 1.3;
        margin: 0;
      }
      .loader {
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top: 4px solid var(--accent-primary);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 10rem auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .centered-message {
        text-align: center;
        font-size: 1.2rem;
        color: var(--foreground-secondary);
        padding: 5rem 1rem;
      }

      /* --- Reader View --- */
      #reader-view {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 200;
        background-color: var(--background-primary);
        overflow: hidden;
      }
      header h2 {
        font-size: 1.4em;
        font-weight: bold;
        color: var(--foreground-secondary);
        margin: 5px;
      }
      #reader-header {
        position: fixed; top: 0; left: 0; right: 0; z-index: 100;
        background-color: var(--reader-header-bg);
        backdrop-filter: blur(14px) saturate(180%);
        -webkit-backdrop-filter: blur(14px) saturate(180%);
        border-bottom: 1px solid var(--reader-border-color);
        display: flex; justify-content: space-between; align-items: center;
        height: 55px; padding: 0 15px;
        transition: transform 0.3s ease-in-out;
      }
      #reader-header.hidden { transform: translateY(-100%); }
      #reader-header .header-left, #reader-header .header-right { display: flex; align-items: center; gap: 15px;}
      #reader-header .header-center { text-align: left; }
      #reader-header h1 { font-size: 17px; margin: 0; font-weight: 600; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; max-width: 50vw; }
      #reader-header p { font-size: 13px; margin: 0; color: #aaa; }
      #reader-back-btn { background: none; border: none; color: var(--foreground-primary); font-size: 24px; cursor: pointer; padding: 0 10px 0 0;}

      #reader-loader {
        position: fixed; top: 50%; left: 50%; z-index: 150;
        transform: translate(-50%, -50%);
        border: 4px solid #444; border-top-color: var(--accent-primary);
        border-radius: 50%; width: 40px; height: 40px;
        animation: spin 1s linear infinite;
      }

      #reader-image-container {
        height: 100vh; width: 100vw;
        overflow-x: hidden; display: flex;
        scroll-behavior: smooth;
      }
      #reader-image-container img {
        width: 100vw; height: 100vh;
        object-fit: contain; flex-shrink: 0;
      }

      .logo {
        font-size: 1.8em;
        font-weight: bold;
        cursor: pointer;
      }
      .logo span {
        color: var(--accent-primary);
      }

      .reader-nav-overlay {
        position: fixed; top: 0; left: 0;
        height: 100%; width: 100%; z-index: 50;
      }
      #reader-nav-left { position: absolute; left: 0; top: 0; width: 35%; height: 100%; cursor: w-resize; }
      #reader-nav-right { position: absolute; right: 0; top: 0; width: 35%; height: 100%; cursor: e-resize; }
      #reader-nav-center { position: absolute; left: 35%; top: 0; width: 30%; height: 100%; cursor: pointer; }

      #reader-footer {
        position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
        background-color: var(--reader-footer-bg);
        backdrop-filter: blur(14px) saturate(180%);
        -webkit-backdrop-filter: blur(14px) saturate(180%);
        border-top: 1px solid var(--reader-border-color);
        height: 45px; display: flex; align-items: center; justify-content: center;
        padding: 0 20px; gap: 20px;
        transition: transform 0.3s ease-in-out;
      }
      #reader-footer.hidden { transform: translateY(100%); }
      #reader-page-progress { width: 100%; max-width: 400px; height: 8px; -webkit-appearance: none; appearance: none; }
      #reader-page-progress::-webkit-progress-bar { background-color: rgba(255, 255, 255, 0.15); border-radius: 4px; }
      #reader-page-progress::-webkit-progress-value { background-color: var(--accent-primary); border-radius: 4px; }
      #reader-page-indicator { font-size: 14px; color: #ccc; font-weight: 500; min-width: 60px; text-align: center; }

    </style>
  </head>
  <body>
    <!-- Main Grid View -->
    <div class="app-container" id="main-container">
      <header class="page-header">
         <div class="logo" onclick="window.location.href='/'">Animex<span>.</span></div>
         <h2>Hentai</h2>
      </header>
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search by title...">
      </div>
      <div id="content-area">
        <div class="loader"></div>
      </div>
    </div>

    <!-- Reader View (Initially Hidden) -->
    <div id="reader-view" style="display: none;">
      <header id="reader-header">
          <div class="header-left">
               <button id="reader-back-btn" aria-label="Go back"><i class="fa fa-arrow-left"></i></button>
               <div class="header-center">
                  <h1 id="reader-manga-title">Loading...</h1>
              </div>
          </div>
      </header>

      <div id="reader-loader" style="display: none;"></div>
      <main id="reader-image-container"></main>

      <div class="reader-nav-overlay">
          <div id="reader-nav-left"></div>
          <div id="reader-nav-center"></div>
          <div id="reader-nav-right"></div>
      </div>
      
      <footer id="reader-footer">
          <progress id="reader-page-progress" value="0" max="100"></progress>
          <span id="reader-page-indicator">0 / 0</span>
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Common State & Elements ---
        const serverIp = localStorage.getItem("extension_server_ip") || "localhost";
        let allHentaiData = [];

        // --- Main Grid Elements ---
        const mainContainer = document.getElementById("main-container");
        const contentArea = document.getElementById("content-area");
        const searchInput = document.getElementById("searchInput");
        
        // --- Reader Elements & State ---
        const readerView = document.getElementById('reader-view');
        const readerImageContainer = document.getElementById('reader-image-container');
        const readerLoader = document.getElementById('reader-loader');
        const readerHeader = document.getElementById('reader-header');
        const readerFooter = document.getElementById('reader-footer');
        const readerMangaTitleEl = document.getElementById('reader-manga-title');
        const readerPageProgress = document.getElementById('reader-page-progress');
        const readerPageIndicator = document.getElementById('reader-page-indicator');
        
        let readerImageLinks = [];
        let readerCurrentPage = 0;

        // --- Initializer ---
        async function init() {
          setupReaderControls();

          const profileId = localStorage.getItem("currentProfileId");
          if (!profileId) {
            showAccessDenied();
            return;
          }
          try {
            const response = await fetch(`http://${serverIp}:7275/profiles/${profileId}`);
            if (!response.ok) throw new Error("Could not fetch profile.");
            const profile = await response.json();

            if (profile.settings && profile.settings.nsfw_enabled) {
              fetchHentaiGrid();
            } else {
              showAccessDenied();
            }
          } catch (error) {
            console.error(error);
            showAccessDenied("Error connecting to server.");
          }
        }

        // --- Grid Functions ---
        function showAccessDenied(message = "NSFW content is disabled for this profile.") {
            contentArea.innerHTML = `<p class="centered-message">${message}</p>`;
        }

        async function fetchHentaiGrid() {
          try {
            // NOTE: The URL uses the parent app's port (7275) and path routing.
            const response = await fetch(`http://${serverIp}:7275/ext/nsfw/chapters`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to fetch content. Server says: ${errorText}`);
            }
            const data = await response.json();
            allHentaiData = data.chapters;
            renderGrid(allHentaiData);
          } catch (error) {
            console.error("Error fetching Hentai:", error);
            contentArea.innerHTML = `<p class="centered-message">${error.message}</p>`;
          }
        }

        function renderGrid(data) {
          contentArea.innerHTML = "";
          const grid = document.createElement("div");
          grid.className = "grid-container";
          
          if (!data || data.length === 0) {
            grid.innerHTML = `<p class="centered-message">No content found.</p>`;
            contentArea.appendChild(grid);
            return;
          }

          data.forEach(item => {
            const card = document.createElement("div");
            card.className = "grid-card";
            card.innerHTML = `
                <img src="${item.image}" alt="${item.title}" loading="lazy">
                <div class="title-overlay">
                    <p class="card-title">${item.title}</p>
                </div>
            `;
            card.addEventListener('click', () => {
                openReader(item.id, item.title);
            });
            grid.appendChild(card);
          });
          contentArea.appendChild(grid);
        }

        searchInput.addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = allHentaiData.filter(item => {
                return item.title.toLowerCase().includes(searchTerm);
            });
            renderGrid(filteredData);
        });

        // --- Reader Functions ---
        async function openReader(chapterId, chapterTitle) {
            mainContainer.style.display = 'none';
            readerView.style.display = 'block';
            readerLoader.style.display = 'block';
            readerImageContainer.innerHTML = '';
            readerMangaTitleEl.textContent = chapterTitle;

            try {
                const response = await fetch(`http://${serverIp}:7275/ext/nsfw/chapter_images/${chapterId}`);
                if (!response.ok) throw new Error(`Server error: ${response.status}`);
                const data = await response.json();
                readerImageLinks = data.images;

                if (!readerImageLinks || readerImageLinks.length === 0) {
                    throw new Error('No images found for this entry.');
                }
                
                renderReaderImages();
            } catch (error) {
                readerMangaTitleEl.textContent = 'Error';
                readerImageContainer.innerHTML = `<p class="centered-message">${error.message}</p>`;
            } finally {
                readerLoader.style.display = 'none';
            }
        }
        
        function renderReaderImages() {
            readerImageLinks.forEach(src => {
                const img = new Image();
                img.src = src;
                readerImageContainer.appendChild(img);
            });
            readerCurrentPage = 0;
            updateReaderPagination();
            updateReaderFooter();
        }

        function closeReader() {
            mainContainer.style.display = 'block';
            readerView.style.display = 'none';
            readerImageContainer.innerHTML = '';
            readerImageLinks = [];
            readerCurrentPage = 0;
        }

        function updateReaderPagination() {
            readerImageContainer.scrollLeft = readerCurrentPage * window.innerWidth;
        }
            
        function updateReaderFooter() {
            if (readerImageLinks.length > 0) {
                readerPageIndicator.textContent = `${readerCurrentPage + 1} / ${readerImageLinks.length}`;
                readerPageProgress.value = readerCurrentPage + 1;
                readerPageProgress.max = readerImageLinks.length;
            } else {
                readerPageIndicator.textContent = `0 / 0`;
                readerPageProgress.value = 0;
                readerPageProgress.max = 0;
            }
        }

        function changeReaderPage(direction) {
            const newPage = readerCurrentPage + direction;
            if (newPage >= 0 && newPage < readerImageLinks.length) {
                readerCurrentPage = newPage;
                updateReaderPagination();
                updateReaderFooter();
            }
        }
        
        function toggleReaderUI() {
            readerHeader.classList.toggle('hidden');
            readerFooter.classList.toggle('hidden');
        }

        function setupReaderControls() {
            document.getElementById('reader-back-btn').addEventListener('click', closeReader);
            document.getElementById('reader-nav-left').addEventListener('click', () => changeReaderPage(-1));
            document.getElementById('reader-nav-right').addEventListener('click', () => changeReaderPage(1));
            document.getElementById('reader-nav-center').addEventListener('click', toggleReaderUI);
        }

        // --- Run Application ---
        init();
      });
    </script>
  </body>
</html>